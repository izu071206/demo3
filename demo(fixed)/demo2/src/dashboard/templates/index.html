<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malware Analysis Expert Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
        
        /* Sidebar */
        .sidebar { width: 260px; position: fixed; top: 0; bottom: 0; background: #2c3e50; color: white; padding: 20px; overflow-y: auto; }
        .main-content { margin-left: 260px; padding: 30px; }
        
        /* Cards */
        .card-shadow { border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-radius: 8px; }
        
        /* Model Selection */
        .card-model { cursor: pointer; border: 1px solid #e0e0e0; transition: all 0.2s; background: white; }
        .card-model:hover { border-color: #3498db; transform: translateY(-2px); }
        .card-model.active { border-color: #3498db; background-color: #ebf5fb; }
        
        /* Tabs Custom */
        .nav-tabs .nav-link { color: #555; cursor: pointer; }
        .nav-tabs .nav-link.active { color: #3498db; font-weight: 600; border-bottom: 2px solid #3498db; }
        .tab-panel { display: none; padding-top: 20px; }
        .tab-panel.active-panel { display: block; }
        
        /* Results */
        .res-obfuscated { border-left: 5px solid #e74c3c; }
        .res-benign { border-left: 5px solid #2ecc71; }
        .res-uncertain { border-left: 5px solid #f1c40f; }
        
        .confidence-track { height: 8px; background: #ecf0f1; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .confidence-bar { height: 100%; transition: width 0.6s ease; }
    </style>
</head>
<body>

<div class="sidebar">
    <h4 class="mb-4 text-center"><i class="fas fa-bug"></i> MalwareDetect</h4>
    
    <div class="mb-4">
        <small class="text-uppercase text-muted" style="font-size: 0.75rem;">Status</small>
        {% if pipeline_ready %}
            <div class="alert alert-success p-2 mt-1 mb-0 small"><i class="fas fa-check-circle"></i> Engine Ready</div>
        {% else %}
            <div class="alert alert-danger p-2 mt-1 mb-0 small"><i class="fas fa-times-circle"></i> Not Ready</div>
            {% if system_error %}
                <div class="text-warning mt-2 small" style="word-break: break-word;">{{ system_error }}</div>
            {% endif %}
        {% endif %}
    </div>

    <div class="small text-muted">
        Scanning: <br> <code style="color: #bdc3c7;">{{ models_dir }}</code>
    </div>
    
    <hr style="border-color: #555;">
    <a href="/" class="text-white text-decoration-none d-block mb-2"><i class="fas fa-home me-2"></i> Dashboard</a>
    <a href="#" onclick="location.reload()" class="text-white-50 text-decoration-none d-block"><i class="fas fa-sync me-2"></i> Refresh App</a>
</div>

<div class="main-content">
    
    <div class="card card-shadow mb-4">
        <div class="card-header bg-white fw-bold py-3 border-bottom-0">
            <i class="fas fa-cogs me-2 text-primary"></i> 1. Select Analysis Models
            <div class="float-end">
                <button class="btn btn-sm btn-link text-decoration-none" onclick="toggleAll(true)">Select All</button>
                <button class="btn btn-sm btn-link text-decoration-none text-muted" onclick="toggleAll(false)">Deselect</button>
            </div>
        </div>
        <div class="card-body bg-light">
            <div class="row g-3" id="modelList">
                {% if available_models %}
                    {% for mid, info in available_models.items() %}
                    <div class="col-md-4">
                        <div class="card-model p-3 rounded h-100" onclick="toggleCard(this)">
                            <div class="form-check pointer-events-none">
                                <input class="form-check-input model-cb" type="checkbox" value="{{ mid }}" checked>
                                <label class="form-check-label fw-bold text-dark">{{ info.display_name }}</label>
                            </div>
                            <div class="small text-muted ms-4">{{ info.type }}</div>
                            {% if info.error %}
                                <div class="text-danger ms-4 small mt-1"><i class="fas fa-exclamation-triangle"></i> Init Failed</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-warning w-100">
                        No models found. Please check <code>{{ models_dir }}</code>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="card card-shadow mb-4">
        <div class="card-header bg-white fw-bold py-3">
            <i class="fas fa-file-import me-2 text-primary"></i> 2. Input Source
        </div>
        <div class="card-body">
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a class="nav-link active" onclick="switchTab('file', this)">Upload File</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="switchTab('github', this)">GitHub URL</a>
                </li>
            </ul>

            <div id="tab-file" class="tab-panel active-panel">
                <div class="text-center p-5 border rounded bg-light" style="border: 2px dashed #ccc;">
                    <i class="fas fa-cloud-upload-alt fa-3x text-secondary mb-3"></i>
                    <h5>Drag & Drop Binary File Here</h5>
                    <p class="text-muted small">Supports .exe, .dll, .bin, .zip</p>
                    <input type="file" id="fileInput" class="form-control w-50 mx-auto mt-3">
                    <button class="btn btn-primary mt-3 px-4" onclick="submitAnalysis('file')">
                        <i class="fas fa-search me-2"></i> Analyze File
                    </button>
                </div>
            </div>

            <div id="tab-github" class="tab-panel">
                <div class="p-4">
                    <label class="form-label fw-bold">GitHub File URL</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fab fa-github"></i></span>
                        <input type="text" id="githubUrl" class="form-control" placeholder="https://github.com/user/repo/blob/main/malware.exe">
                        <button class="btn btn-primary" onclick="submitAnalysis('github')">
                            <i class="fas fa-download me-2"></i> Fetch & Analyze
                        </button>
                    </div>
                    <div class="form-text mt-2">Note: 'blob' URLs are automatically converted to 'raw'.</div>
                </div>
            </div>
        </div>
    </div>

    <div id="loading" class="text-center my-5" style="display: none;">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <h5 class="mt-3 text-muted">Running Analysis Pipelines...</h5>
    </div>

    <div id="resultsArea"></div>

    {% if history %}
    <div class="mt-5">
        <h5 class="mb-3">Recent Analysis</h5>
        <div class="table-responsive bg-white rounded shadow-sm">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Time</th>
                        <th>Filename</th>
                        <th>Consensus</th>
                        <th>Models</th>
                    </tr>
                </thead>
                <tbody>
                    {% for h in history %}
                    <tr>
                        <td>{{ h.timestamp.split('T')[0] }}</td>
                        <td>{{ h.filename }}</td>
                        <td>
                            <span class="badge bg-{{ 'danger' if h.consensus.consensus == 'Obfuscated' else 'success' }}">
                                {{ h.consensus.consensus }}
                            </span>
                        </td>
                        <td>{{ h.models_used|length }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <button class="btn btn-sm btn-outline-danger mt-2" onclick="clearHistory()">Clear History</button>
    </div>
    {% endif %}

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- UI INTERACTION ---
    function switchTab(targetId, navEl) {
        // Remove active class from all links
        document.querySelectorAll('.nav-tabs .nav-link').forEach(el => el.classList.remove('active'));
        // Hide all panels
        document.querySelectorAll('.tab-panel').forEach(el => el.classList.remove('active-panel'));
        
        // Activate clicked
        navEl.classList.add('active');
        document.getElementById('tab-' + targetId).classList.add('active-panel');
    }

    function toggleCard(card) {
        const cb = card.querySelector('input');
        cb.checked = !cb.checked;
        if(cb.checked) card.classList.add('active');
        else card.classList.remove('active');
    }

    function toggleAll(state) {
        document.querySelectorAll('.card-model').forEach(card => {
            const cb = card.querySelector('input');
            cb.checked = state;
            if(state) card.classList.add('active');
            else card.classList.remove('active');
        });
    }

    // --- API LOGIC ---
    function submitAnalysis(sourceType) {
        const models = Array.from(document.querySelectorAll('.model-cb:checked')).map(cb => cb.value);
        
        if (models.length === 0) {
            alert("Please select at least one model.");
            return;
        }

        const fd = new FormData();
        models.forEach(m => fd.append('models[]', m));

        if (sourceType === 'file') {
            const f = document.getElementById('fileInput').files[0];
            if (!f) return alert("Please select a file.");
            fd.append('file', f);
        } else {
            const url = document.getElementById('githubUrl').value.trim();
            if (!url) return alert("Please enter a URL.");
            fd.append('github_url', url);
        }

        // UI Loading
        document.getElementById('loading').style.display = 'block';
        document.getElementById('resultsArea').innerHTML = '';

        fetch('/predict', { method: 'POST', body: fd })
        .then(res => {
            if(res.status === 503) throw new Error("System not ready. Check backend.");
            return res.json();
        })
        .then(data => {
            document.getElementById('loading').style.display = 'none';
            if (data.error) {
                renderError(data.error);
            } else {
                renderResults(data.files);
            }
        })
        .catch(err => {
            document.getElementById('loading').style.display = 'none';
            renderError(err.message);
        });
    }

    function renderError(msg) {
        document.getElementById('resultsArea').innerHTML = `
            <div class="alert alert-danger shadow-sm">
                <h5 class="alert-heading"><i class="fas fa-exclamation-circle"></i> Analysis Failed</h5>
                <p>${msg}</p>
            </div>`;
    }

    function renderResults(files) {
        let html = '';
        files.forEach((file, idx) => {
            const cons = file.consensus;
            const cardClass = cons.consensus === 'Obfuscated' ? 'res-obfuscated' : (cons.consensus === 'Benign' ? 'res-benign' : 'res-uncertain');
            const badgeClass = cons.consensus === 'Obfuscated' ? 'bg-danger' : (cons.consensus === 'Benign' ? 'bg-success' : 'bg-warning text-dark');

            html += `
            <div class="card card-shadow mb-4 ${cardClass}">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="m-0"><i class="fas fa-file-code me-2"></i> ${file.filename}</h5>
                    <span class="badge ${badgeClass} fs-6 px-3 py-2">${cons.consensus.toUpperCase()}</span>
                </div>
                <div class="card-body">
                    <div class="row mb-4 text-center">
                        <div class="col-3 border-end">
                            <small class="text-muted">Agreement</small>
                            <h4 class="fw-bold">${cons.agreement}%</h4>
                        </div>
                        <div class="col-3 border-end">
                            <small class="text-muted">Avg Confidence</small>
                            <h4 class="fw-bold">${(cons.avg_confidence * 100).toFixed(1)}%</h4>
                        </div>
                        <div class="col-3 border-end text-danger">
                            <small class="text-muted">Obfuscated Votes</small>
                            <h4 class="fw-bold">${cons.obf}</h4>
                        </div>
                        <div class="col-3 text-success">
                            <small class="text-muted">Benign Votes</small>
                            <h4 class="fw-bold">${cons.ben}</h4>
                        </div>
                    </div>

                    <div class="accordion" id="acc-${idx}">
            `;

            // Loop models
            let mIdx = 0;
            for (const [mid, res] of Object.entries(file.results)) {
                if (res.error) {
                    html += `
                    <div class="alert alert-light border text-danger small p-2 mb-2">
                        <strong>${mid}:</strong> ${res.error}
                    </div>`;
                    continue;
                }

                const isObf = res.prediction === 'Obfuscated';
                const color = isObf ? '#e74c3c' : '#2ecc71';
                const pct = (res.confidence * 100).toFixed(1);

                html += `
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button ${mIdx > 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#col-${idx}-${mIdx}">
                            <div class="d-flex w-100 justify-content-between align-items-center me-3">
                                <span>
                                    <strong>${res.model_name}</strong> 
                                    <span class="badge bg-light text-dark border ms-2">${res.model_type}</span>
                                </span>
                                <span style="color: ${color}; font-weight: bold;">
                                    ${res.prediction} (${pct}%)
                                </span>
                            </div>
                        </button>
                    </h2>
                    <div id="col-${idx}-${mIdx}" class="accordion-collapse collapse ${mIdx === 0 ? 'show' : ''}" data-bs-parent="#acc-${idx}">
                        <div class="accordion-body">
                            <div class="row align-items-center">
                                <div class="col-md-2 text-muted small">Confidence</div>
                                <div class="col-md-8">
                                    <div class="confidence-track">
                                        <div class="confidence-bar" style="width: ${pct}%; background-color: ${color};"></div>
                                    </div>
                                </div>
                                <div class="col-md-2 text-end small text-muted">
                                    <i class="fas fa-clock"></i> ${res.processing_time}s
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
                mIdx++;
            }

            html += `</div></div></div>`; // Close card
        });
        document.getElementById('resultsArea').innerHTML = html;
    }

    function clearHistory() {
        if(confirm("Clear history?")) {
            fetch('/api/history', {method:'DELETE'}).then(() => location.reload());
        }
    }
</script>
</body>
</html>


# Hướng Dẫn Test với Malware

## ⚠️ CẢNH BÁO BẢO MẬT

**QUAN TRỌNG**: Khi làm việc với malware, bạn PHẢI:

1. **Sử dụng môi trường cách ly**: VM hoặc sandbox
2. **Không chạy trên hệ thống production**
3. **Tuân thủ pháp luật**: Chỉ phân tích malware hợp pháp (của bạn hoặc có giấy phép)
4. **Backup dữ liệu**: Đảm bảo có backup trước khi test
5. **Network isolation**: Tắt kết nối mạng khi test

## Môi Trường Khuyến Nghị

### Option 1: Virtual Machine
- VMware, VirtualBox, hoặc Hyper-V
- Windows 10/11 hoặc Linux
- Tối thiểu 4GB RAM, 50GB disk
- Snapshot trước khi test

### Option 2: Sandbox
- Cuckoo Sandbox
- CAPE Sandbox
- Joe Sandbox
- Any.run

## Chuẩn Bị

### 1. Setup Môi Trường

```bash
# Tạo VM snapshot
# Cài đặt Python và dependencies
pip install -r requirements.txt

# Tạo cấu trúc thư mục
python scripts/create_sample_structure.py
```

### 2. Train Models Trước

Bạn cần có models đã được train trước:

```bash
# Tạo dataset từ benign và obfuscated samples
python main.py generate-dataset

# Train models
python main.py train
```

## Test với Malware Sample

### Cách 1: Sử dụng Script

```bash
python scripts/test_malware.py <path_to_malware> \
    --model models/random_forest_model.pkl \
    --model-type random_forest \
    --output results/malware_test.json
```

### Cách 2: Sử dụng Dashboard

1. Chạy dashboard:
```bash
python main.py dashboard
```

2. Mở browser: http://localhost:5000
3. Upload file malware (trong VM/sandbox)
4. Xem kết quả

### Cách 3: Sử dụng Python API

```python
from scripts.test_malware import extract_features_from_sample, predict_with_model

# Extract features
features = extract_features_from_sample("path/to/malware.exe")

# Predict
results = predict_with_model(
    "models/random_forest_model.pkl",
    "random_forest",
    features
)

print(f"Prediction: {results['prediction']}")
print(f"Confidence: {results['confidence']}")
```

## Phân Tích Kết Quả

### Kết Quả Dự Đoán

- **Benign**: File không bị obfuscate (hoặc obfuscation nhẹ)
- **Obfuscated**: File có dấu hiệu obfuscation

### Độ Tin Cậy

- **> 0.9**: Rất cao
- **0.7 - 0.9**: Cao
- **0.5 - 0.7**: Trung bình
- **< 0.5**: Thấp (có thể cần kiểm tra lại)

### False Positives/Negatives

- **False Positive**: File benign bị nhận diện là obfuscated
  - Có thể do code phức tạp tự nhiên
  - Cần review lại features

- **False Negative**: File obfuscated bị nhận diện là benign
  - Có thể do obfuscation technique mới
  - Cần cập nhật dataset

## Best Practices

### 1. Test với Nhiều Models

```bash
# Test với Random Forest
python scripts/test_malware.py sample.exe --model models/random_forest_model.pkl --model-type random_forest

# Test với XGBoost
python scripts/test_malware.py sample.exe --model models/xgboost_model.json --model-type xgboost

# Test với Neural Network
python scripts/test_malware.py sample.exe --model models/neural_network_model.pt --model-type neural_network
```

### 2. So Sánh Kết Quả

So sánh kết quả từ nhiều models để có độ tin cậy cao hơn.

### 3. Log và Document

Ghi lại:
- Sample hash (MD5, SHA256)
- Kết quả prediction
- Confidence scores
- Observations

### 4. Cập Nhật Dataset

Nếu phát hiện false positives/negatives:
- Thêm samples vào dataset
- Retrain models
- Cải thiện features nếu cần

## Troubleshooting

### Lỗi khi extract features

**Vấn đề**: Không extract được features từ malware

**Giải pháp**:
- Kiểm tra file có phải binary hợp lệ
- Kiểm tra architecture (x86, x64, ARM)
- Xem logs để biết chi tiết

### Model không load được

**Vấn đề**: Lỗi khi load model

**Giải pháp**:
- Kiểm tra đường dẫn model
- Kiểm tra model type
- Đảm bảo model đã được train

### Feature dimension mismatch

**Vấn đề**: Features không khớp với model input

**Giải pháp**:
- Đảm bảo extract features với cùng config như khi train
- Kiểm tra feature extraction pipeline

## Ví Dụ Workflow

```bash
# 1. Setup môi trường (trong VM)
cd /path/to/demo2
python scripts/create_sample_structure.py

# 2. Train models (với benign và obfuscated samples đã có)
python main.py generate-dataset
python main.py train

# 3. Test với malware sample
python scripts/test_malware.py \
    /path/to/malware/sample.exe \
    --model models/random_forest_model.pkl \
    --model-type random_forest \
    --output results/malware_analysis.json

# 4. Xem kết quả
cat results/malware_analysis.json

# 5. So sánh với các models khác
python scripts/test_malware.py \
    /path/to/malware/sample.exe \
    --model models/xgboost_model.json \
    --model-type xgboost
```

## Lưu Ý Pháp Lý

- Chỉ phân tích malware mà bạn sở hữu hoặc có quyền phân tích
- Tuân thủ các quy định về malware research
- Không chia sẻ malware samples
- Báo cáo findings một cách có trách nhiệm

## Tài Liệu Tham Khảo

- [Malware Analysis Best Practices](https://www.sans.org/white-papers/malware-analysis/)
- [VMware Security](https://www.vmware.com/security/)
- [Cuckoo Sandbox Documentation](https://cuckoo.sh/docs/)

